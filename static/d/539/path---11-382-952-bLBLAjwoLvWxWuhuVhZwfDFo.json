{"pageContext":{"group":[{"node":{"id":"bbeac3b2-ca32-57e8-8ff0-df855952cee5","html":"<p>　　“你说哪条路我知道，但‘挪威森林’小区我可没听说过。”乘客张璇说完目的地，出租车司机就一通抱怨：“你说好好的小区，干吗非得起个洋名？怪里怪气，找起来也麻烦，根本不知道在哪儿！”</p>\n<p>　　来回绕了两圈，没找到小区大门。张璇看附近楼房比较眼熟，就赶紧下了车，却发现是其他小区。“建筑风格差不多，又是洋名字，傻傻分不清。”</p>\n<p>　　好不容易找到一位正在执勤的小区保安，在保安的指引下，总算找到了目的地。“本地人也不知道在哪儿，问起路来太费劲！”张璇抱怨。</p>\n<p>　　张璇所在的西南某省会城市，不管是商业小区还是购物中心，“洋名”占的比例可不低。部分公交车站也以附近小区或者商场命名，从而出现被“洋地名”的现象。</p>\n<!--more-->\n<p>　　实际上，这并不是该城市的独特现象。创意英国、香榭丽舍、挪威森林、金色维也纳、阿拉丁花园、玛雅生活馆、波西米亚花园、地中海、名古屋、戛纳风情街、泰晤士小镇……国内许多城市都散布着“洋地名”，“曼哈顿”“泰晤士”扎堆出现，“维也纳”“地中海”层出不穷。</p>\n<p>　　张璇记得，上学时和小伙伴们常常到工人文化宫玩耍，听大人讲这个城市的人和事。如今这些名字都已经成为过去式，原有道路被改造成商业片区，也换上了和时髦外表相应的“洋名”。</p>\n<p>　　小区喜欢用洋名，觉得用了洋名，品位就提高了。对国际化的非理性看法，导致了“洋地名”泛滥，其中商业炒作发挥了推波助澜的作用。</p>\n<p>　　不过市民对“洋地名”却不怎么买账。“原本记得大概位置的，有些地方换了站名，找都找不到了；有些‘洋地名’，记都记不住，说也说不出来。”一位老年市民抱怨，不少地名盲目跟风，导致土生土长的他“在自己家，却迷了路”。</p>\n<p>　　“假如翠湖旁边的小区改名叫瓦尔登别墅，轿子雪山景区的酒店改称阿尔卑斯小屋，你会怎么想？在‘名古屋’甩米线，听起来就别扭！”调侃吐槽的背后，更说明城市的发展需要格外呵护历史传统和文化底蕴，这也是不同城市各自魅力的根源所在。</p>\n<p>　　“如果国外游客请一位热情好客的市民留个地址以便以后交往，市民留的地址是：某市戛纳风情街或者泰晤士小镇，你说外国人会有什么样的看法？”城市历史研究者赵立认为，消解传统文化并不是非要拆旧建筑、烧古书，地名变成洋名，也是一种隐性的消解。</p>\n<p>　　“不少传统地名能够解读出一个地方大概的位置、曾经发生过的历史事件，地名承载了一个地方的地理、历史、文化信息，盲目使用‘洋地名’，会造成传统文化的断代。”云南大学建筑与规划学院国际交流部部长汪洁泉告诉记者，一个好的地名不仅有助于指示方位、方便居民生活，更能唤起年轻一代对城市历史的兴趣，增强年轻一代对城市的认同感。</p>\n<p>　　地名是地方文化的重要标志，每个地方气候地理、风俗习惯、生活方式各不相同，因此也会形成不同的“地名文化”。胡乱起洋名，必会破坏这些文化传承。对洋地名的追逐，不仅容易迷失自我，还照见了一种懒惰思维，更折射出一种文化的不自信。其实，《地名管理条例实施细则》明确规定不以外国人名、地名命名我国地名，其中包括居民区、楼群、建筑物等。目前，清理整治居民区、大型建筑物、街巷、道路、桥梁等地名中存在的“大、洋、怪、重”等不规范地名的工作正在进行，希望各地在更名工作中更加注重历史文脉保护。</p>\n<p>　　——编 后</p>\n<p>[<a target=\"_blank\" href=\"http://paper.people.com.cn/rmrb/html/2016-04/10/nw.D110000renmrb_20160410_6-01.htm\">原文：《 人民日报 》（ 2016年04月10日 01 版）</a>]</p>\n<hr>","frontmatter":{"path":"/fM7xdZlCZeEbnWHzsUKY0DJB","title":"随意取洋名，真叫人犯晕","date":"2016-08-24 03:13:56 +0800","comments":true,"author":"杨文明","tags":["思考"]},"excerpt":"…"}},{"node":{"id":"5a0f4da0-7870-53b1-af9d-30000bc6b342","html":"<p>以前用 <code>hexo</code> 维护网站的时候评论系统用的是多说，虽然 <code>octopress</code> 自带了一个 <code>disqus</code> 评论系统，不过感觉还是没有多说强大。所以这次改版之后也决定用多说。</p>\n<h2> </h2>\n<h3>添加文章评论</h3>\n<p>在 <code>_config.yml</code> 中找到 <code>disqus</code> 配置</p>\n<pre><code class=\"language-yml\"># Disqus Comments\ndisqus_short_name:\ndisqus_show_comment_count: false\n</code></pre>\n<!--more-->\n<p>在下面添加</p>\n<pre><code class=\"language-yml\">duoshuo_comments: true\nduoshuo_short_name: xxxxxx  # 多说帐号\n</code></pre>\n<p>在 <code>source/_layouts/post.html</code> 中的 <code>disqus</code> 代码</p>\n<pre><code class=\"language-html\">{% if site.disqus_short_name and page.comments == true %}\n  &#x3C;section>\n    &#x3C;h1>&#x3C;i class=\"fa fa-comments\">&#x3C;/i> Comments&#x3C;/h1>\n    &#x3C;div id=\"disqus_thread\" aria-live=\"polite\">{% include post/disqus_thread.html %}&#x3C;/div>\n  &#x3C;/section>\n{% endif %}\n</code></pre>\n<p>下面添加多说的模块</p>\n<pre><code class=\"language-html\">{% if site.duoshuo_short_name and site.duoshuo_comments == true and page.comments == true %}\n  &#x3C;section>\n    &#x3C;h1>&#x3C;i class=\"fa fa-comments\">&#x3C;/i> Comments&#x3C;/h1>\n    &#x3C;div id=\"comments\" aria-live=\"polite\">{% include post/duoshuo.html %}&#x3C;/div>\n  &#x3C;/section>\n{% endif %}\n</code></pre>\n<p>然后创建上面代码提及的新文件 <code>post/duoshuo.html</code> 具体路径是 <code>source/_includes/post/duoshuo.html</code></p>\n<pre><code class=\"language-html\">&#x3C;!-- 多说评论框 start -->\n&#x3C;div class=\"ds-thread\" data-thread-key=\"{% if site.titlecase %}{{ page.title | titlecase }}{% else %}{{ page.title }}{% endif %}\" data-title=\"{% if site.titlecase %}{{ page.title | titlecase }}{% else %}{{ page.title }}{% endif %}\" data-url=\"{{page.previous.url}}\">&#x3C;/div>\n&#x3C;!-- 多说评论框 end -->\n&#x3C;!-- 多说公共JS代码 start (一个网页只需插入一次) -->\n&#x3C;script type=\"text/javascript\">\n    var duoshuoQuery = {short_name:\"{{ site.duoshuo_short_name }}\"};\n    (function() {\n        var ds = document.createElement('script');\n        ds.type = 'text/javascript';ds.async = true;\n        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';\n        ds.charset = 'UTF-8';\n        (document.getElementsByTagName('head')[0]\n         || document.getElementsByTagName('body')[0]).appendChild(ds);\n    })();\n&#x3C;/script>\n&#x3C;!-- 多说公共JS代码 end -->\n</code></pre>\n<h5>* 这里注意一下 <code>data-thread-key</code> 属性，如果不写，控制台会有警告信息。设置成跟 <code>data-title</code> 一样就好。</h5>\n<p>学 <code>disqus</code> 的实现方式，在文章头部也再加个评论按钮。修改 <code>_includes/article.html</code> 文件。</p>\n<pre><code class=\"language-html\">{% if site.disqus_short_name and page.comments != false and post.comments != false and site.disqus_show_comment_count == true %}\n   | &#x3C;a href=\"{% if index %}{{ root_url }}{{ post.url }}{% endif %}#disqus_thread\"\n     data-disqus-identifier=\"{% if post.meta.disqus_id %}{{ post.meta.disqus_id }}{% else %}{{ site.url }}{{ post.url }}{% endif %}\">Comments&#x3C;/a>\n{% endif %}\n</code></pre>\n<p>下方添加多说代码部分</p>\n<pre><code class=\"language-html\">{% if site.duoshuo_short_name and page.comments != false and post.comments != false and site.duoshuo_comments == true %}\n | &#x3C;a href=\"{% if index %}{{ root_url }}{{ post.url }}{% endif %}#comments\">评论&#x3C;/a>\n{% endif %}\n</code></pre>\n<p>基本功能大功告成</p>\n<h2> </h2>\n<h3>侧边栏现实最新评论</h3>\n<p>在 _config.yml 添加如下配置:</p>\n<pre><code class=\"language-yml\">duoshuo_asides: false       # 是否显示侧边栏\nduoshuo_asides_num: 10      # 侧边栏评论显示条目数\nduoshuo_asides_avatars: 0   # 侧边栏评论是否显示头像\nduoshuo_asides_time: 0      # 侧边栏评论是否显示时间\nduoshuo_asides_title: 0     # 侧边栏评论是否显示标题\nduoshuo_asides_admin: 0     # 侧边栏评论是否显示作者评论\nduoshuo_asides_length: 18   # 侧边栏评论截取的长度\n</code></pre>\n<p>还需要在侧边栏插件文件夹创建评论代码</p>\n<pre><code class=\"language-html\">{% if site.duoshuo_asides %}\n&#x3C;section>\n    &#x3C;h1>&#x3C;i class=\"fa fa-comments\">&#x3C;/i> Recent Comments&#x3C;/h1>\n    &#x3C;ul class=\"ds-recent-comments\" data-num-items=\"{{ site.duoshuo_asides_num }}\" data-show-avatars=\"{{ site.duoshuo_asides_avatars }}\" data-show-time=\"{{ site.duoshuo_asides_time }}\" data-show-title=\"{{ site.duoshuo_asides_title }}\" data-show-admin=\"{{ site.duoshuo_asides_admin }}\" data-excerpt-length=\"{{ site.duoshuo_asides_length }}\">&#x3C;/ul>\n    {% if index %}\n    &#x3C;!--多说js加载开始，一个页面只需要加载一次 -->\n    &#x3C;script type=\"text/javascript\">\n      var duoshuoQuery = {short_name:\"{{ site.duoshuo_short_name }}\"};\n      (function() {\n        var ds = document.createElement('script');\n        ds.type = 'text/javascript';ds.async = true;\n        ds.src = 'http://static.duoshuo.com/embed.js';\n        ds.charset = 'UTF-8';\n        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);\n      })();\n    &#x3C;/script>\n    &#x3C;!--多说js加载结束，一个页面只需要加载一次 -->\n    {% endif %}\n&#x3C;/section>\n{% endif %}\n</code></pre>\n<p>如果没有评价，不需要显示孤零零的变迁，可以把 <code>duoshuo_asides</code> 设置成 <code>false</code>。</p>\n<p>最后在 <code>_config.yml</code> 的侧边栏数组中添加页面</p>\n<pre><code class=\"language-yml\">default_asides: [asides/about.html, asides/recent_posts.html, asides/recent_comments.html, asides/links.html, asides/github.html, asides/delicious.html, asides/pinboard.html, asides/googleplus.html]\n</code></pre>\n<p>我选择在最新文章和链接之间显示最新评论。</p>\n<hr>","frontmatter":{"path":"/NgHhhZtj9hAW8PSWKfQB9WEH","title":"Octopress 博客添加多说评论系统","date":"2016-08-17 20:07:10 +0800","comments":true,"author":"Sir0xb","tags":["octopress","多说"]},"excerpt":"以前用  hexo  维护网站的时候评论系统用的是多说，虽然  octopress  自带了一个  disqus  评论系统，不过感觉还是没有多说强大。所以这次改版之后也决定用多说。   添加文章评论 在  _config.yml  中找到  disqus…"}},{"node":{"id":"94a2599b-d042-56b4-afb5-970ca7d0c529","html":"<p>github 很慷慨的为程序员们提供了静态站功能，还给开启了 https 访问。比如我的站点 [<a target=\"_blank\" href=\"https://sir0xb.github.io\">https://sir0xb.github.io</a>]。虽然也很不错，不过对于想要追求完美的人来说，总感觉少了点什么(独立域名呗)。不过申请了独立域名之后，github 提供的 https 访问方式没发继续了。</p>\n<p>我的域名是阿里云(原来叫万网)购买的，就以阿里为例讲下如何解决 https 访问问题。</p>\n<h4>1.在 [<a target=\"_blank\" href=\"https://www.cloudflare.com\">https://www.cloudflare.com</a>] 注册帐号</h4>\n<p>具体注册过程不讲了，将自己的域名验证完之后，可以在 DNS 标签得到如下两个解析地址。</p>\n<!--more-->\n<img src=\"https://i.imgur.com/p7uRqpL.png\" />\n<h4>2.修改阿里云 DNS 记录</h4>\n<p>用上一步得到的两个地址，修改阿里云 DNS 解析记录。</p>\n<img src=\"https://i.imgur.com/fOhAymC.png\" />\n<p>成功之后回到 cloudflare 的 Overview 标签能看到状态变绿了。</p>\n<img src=\"https://i.imgur.com/so8qD0E.png\" />\n<h4>3.添加域名解析记录</h4>\n<p>具体内容跟在阿里云添加的记录是一样的，一个 www 记录，一个 @ 记录。</p>\n<img src=\"https://i.imgur.com/ArPnY7M.png\" />\n<p>具体 ip 地址获得方式，可以参考 [<a target=\"_blank\" href=\"\">解决 Github 邮件中提示的问题</a>]。</p>\n<h4>4.设置 ssl 解析方式</h4>\n<p>可以根据自己的喜好选一个，我自己弄了个动态方式。</p>\n<img src=\"https://i.imgur.com/MSvbMH3.png\" />\n<h4>5.添加地址过滤</h4>\n<p>地址过滤其实是过滤 http 地址，将其转跳到 https 地址。</p>\n<img src=\"https://i.imgur.com/bcOalQ9.png\" />\n<h4>^_^ 大功告成</h4>\n<hr>","frontmatter":{"path":"/yO73AClUeYfeLtkW2HPEMezG","title":"独立域名 pages 配置 https 访问","date":"2016-08-16 21:10:55 +0800","comments":true,"author":"Sir0xb","tags":["pages","https","cloudflare"]},"excerpt":"github 很慷慨的为程序员们提供了静态站功能，还给开启了 https 访问。比如我的站点  https://sir0xb.github.io 。虽然也很不错，不过对于想要追求完美的人来说，总感觉少了点什么(独立域名呗)。不过申请了独立域名之后，github 提供的 https…"}},{"node":{"id":"ca4dccc3-1b21-5733-a038-1b0a2df0ff77","html":"<p>　　我们必需正视：一种文化上自我糟蹋的潮流正在所向披靡。</p>\n<p>　　我们悠久历史养育和积淀下来的文化精华，尤其那些最驰名、最响亮、最惹眼、最具影响的——从名城、名镇、名街、名人、名著，到名人死后的墓室和名著里出名的主人公，乃至列入国家名录的各类各种文化遗产等等，都在被浓妆艳抹，重新包装，甚至拆卸重组，再描龙画凤，披金戴银，挤眉弄眼，招摇于市。</p>\n<!--more-->\n<p>　　那些在“城改”中残剩无多的历史街区，忽然被聪明地发现，它们竟是一种天赐的旅游资源。已经拆掉的无法复原，没拆的虽然不再拆了，但也难逃厄运——全被开发成商业风情街——实际上是风情商业街。更糟糕的是被世人称作“最后的精神家园”的古村古镇，正在被“腾笼换鸟”，迁走原住民，然后大举招商，一个个被改造成各类商铺、旅店、农家乐、茶社和咖啡屋混成一团的“游客的天堂”；在这天堂里连一间见证历史的“博物馆”也没有，导游讲的故事传说不少是为吸引游人而编造的伪民间故事。至于各种名人故居，大都是找来一些与其主人毫不相干的红木家具、老瓶老壶、文房四宝，三流字画，不伦不类地摆一摆，好歹布置个模样；没人拿名人的人当回事，只拿名人的名当回事。还有那种原本安慰心灵的寺庙，无一例外全成了世俗的闹市。至于种种文化遗产，更是这种热热闹闹重新“打造”的对象。其中的历史的内涵、文化的意蕴、本土气质和个中独特的精神跑到哪去了？没人管也没人问。</p>\n<p>　　有人说旅游原本就是走马观花的快餐文化，用不着太认真。那么，就再看看我们影视中的历史文化吧。</p>\n<p>　　我们的历史名人只要跑到银幕和荧屏上，不论明君重臣，还是才子佳人，大都多了一身好功夫，动不动大打出手，甚至背剑上房。他们好像都活在时光隧道里。虽然身着古装，发型和配带却像时尚名模；没有切确的朝代与地域，一切衣食住行的道具、物品和礼俗全是胡编乱造；有个老样子就行，或者愈怪愈好，历史在这里只是借用一下的名义，一个空袋子，任什么乱七八糟、炫人耳目的东西都往里边塞。</p>\n<p>　　一边是真实的历史被抽空内涵，只留下躯壳，再滥加改造；一边是荒诞不经和无中生有的伪造——这便是当今国人眼中的历史文化。</p>\n<p>　　经过这样的粗鄙化的打造，在人们眼里，古村古镇无非是些年久失修的老房子，名人故居不过是名人在世时住过的几间屋子，庙宇都是烧香叩头却不知灵验不灵验的地方，历史上的人物全有几招花拳绣腿，全离不开男欢女爱，全不正经；没有庄重感、神圣感、厚重感、甚至美感。我们不是把中华文化博大精深挂在嘴边吗？如今国人从哪里能够感知这种博大精深？只能去一座城市才有一个的博物馆吗？</p>\n<p>　　文化不精不深，怎样可能“做大做强”？真正强大的文化一定又精又深。比如唐诗宋词、维也纳的音乐、俄罗斯文学和美国电影。只有在精深的文化中，才会有大作品和大家的出现，社会文明才能整体地提高。</p>\n<p>　　问题是当下这种鄙俗化的潮流，这种放肆的粗制滥造，这种充满谬误、以假乱真的伪文化，正在使我们的文化变得粗浅、轻薄、空洞、可笑、庸俗，甚至徒有虚名，一边有害公众的文化情怀和历史观，一边伤及中华文化的纯正及其传承。我相信，在这样文化环境中成长起来的一代，很难对自己文化心怀挚爱与虔敬。如果我们不再深爱和敬重自己的文化，再伟大的文化不也要名存实亡？到底什么动机与力量使这种潮流正在变本加厉？我想应当一句话戳穿，即以文化谋利。为了赚钱发财，为了GDP。GDP是衡量政绩的尺度——这也是问题的关键与症结之一。</p>\n<p>　　任何事物进入市场，就不免受到市场规律的制约，不免依照消费需求和商业利益调整自己。但调整是科学调整，不能扭曲甚至破坏自己去换取经济利益，就像自然资源的开发不能破坏生态。文化更具特殊性。因为文化的最重要的社会功能是精神功能。它直接影响着社会文明与全民素质。不能为了畅销、热销、票房、上座率和收视率成倍增长，为了市场人气攀升，为了利润的最大化和“疯狂的GDP”，而放弃文化固有的精神的准则。即文明的、知识的、道德的、真善美的准则。这准则也是文化的尊严，这尊严一旦被践踏被玷污，文化也失去它存在的意义。因为被糟蹋的文化反过来一定还会糟蹋人的精神。</p>\n<p>　　由此说，问题真正的要害——不是拿文化赚钱，而是糟蹋文化来赚钱。还有比这样赚钱更无知、更野蛮吗？</p>\n<p>　　当社会文明素质上升时，愈美好的东西愈有市场；当社会文明素质低下时，愈鄙俗的东西愈有市场。为什么我们为赢得市场和收视率就去迁就低俗，甚至不惜糟蹋我们的文化？</p>\n<p>　　我们是否听到我们的文化正在呼叫：不要糟蹋自己的文化了！</p>\n<p>　　任何有文化良心的人，都不能回避这个声音。</p>\n<p>[<a target=\"_blank\" href=\"http://blog.sina.com.cn/s/blog_46e7b3fd0100kyas.html\">原文：冯骥才</a>]</p>\n<hr>","frontmatter":{"path":"/6gj4wYyzm2fKgEdjWUHg0SIK","title":"请不要糟蹋我们的文化","date":"2016-08-12-13:15:41 +0800","comments":true,"author":"冯骥才","tags":["思考"]},"excerpt":"…"}},{"node":{"id":"42c7389b-2212-554c-b346-71f4f5b5746b","html":"<p>用 Node.js 的 Stream 概念，gulp 实现了一套自己的 pipe，再包裹上 Promise 机制，让每个功能在一个接一个的管道中流过，宏观上实现我们需要它完成的 Task。Task 很好用，于是用了很多，结果 gulpfile 变得很长，每次修改就要费劲找好长时间，径管理也比较麻烦，很不好维护。是时候彻底重构一下了。</p>\n<h3>用 es6 替代 coffee</h3>\n<p>脚本原来是用 coffee 维护的，既能减少代码长度，又能避免未返回 gulp 对象所引起的断流问题。不过毕竟 coffee 已经不维护了，也没有自带的模块开发功能，所以这次决定改版成 es6 方式。</p>\n<!--more-->\n<p>先引入 <code>babel-core</code> 和 <code>babel-preset-es2015</code> 这两个包</p>\n<p>配置 package.json</p>\n<pre><code class=\"language-json\">...\n\"babel\": {\n    \"presets\": [\n        \"es2015\"\n    ]\n}\n...\n</code></pre>\n<p>es6 用的脚本名称不再是 <code>gulpfile.js</code>，需要改成 <code>gulpfile.babel.js</code></p>\n<p>es6 环境搭建完成。</p>\n<h2> </h2>\n<h3>目录结构优化</h3>\n<img src=\"https://i.imgur.com/acdX7Uc.jpg\" />\n<p><code>fescripts</code> 文件夹作为脚本主目录，只放一些配置文件及任务文件夹。</p>\n<p><code>tasks</code> 文件夹存放需要根据环境调用的任务。像 <code>default.task.js</code> 平时开发时调用，<code>build.task.js</code> 在服务器发布环境中运行。</p>\n<p><code>cleaner</code>、<code>compile</code>、<code>debug</code> 等文件夹存放具体小功能(就是原来 <code>gulpfile.js</code> 里的 task)。</p>\n<h2> </h2>\n<h3>配置文件说明 <code>gulp.config.js</code></h3>\n<pre><code class=\"language-javascript\">'use strict';\n\nimport Q from 'q';\n\nmodule.exports = function ({ isDev = false, stage = \"test\" } = {}) {\n    let config = {\n        isDev: isDev,\n        system_list: (() => {\n            if (isDev) {\n                return [\n                    \"alphago/livecast/livecast-web/livecast-crm-webapp/src/main/webapp\",\n                    \"alphago/livecast/livecast-web/livecast-student-webapp/src/main/webapp\",\n                    \"alphago/livecast/livecast-web/livecast-teacher-webapp/src/main/webapp\"\n                ];\n            } else {\n                return [\n                    `./build-repo/build-${stage}/livecast-crm-webapp/webroot`,\n                    `./build-repo/build-${stage}/livecast-student-webapp/webroot`,\n                    `./build-repo/build-${stage}/livecast-teacher-webapp/webroot`\n                ];\n            }\n        })(),\n        great_promise: function(gulpJob, prams = true) {\n            let deferred = Q.defer();\n            let promiseArray = [];\n\n            this.system_list.forEach((base) => {\n                let def = Q.defer();\n\n                gulpJob(base, def);\n\n                promiseArray.push(def.promise);\n            });\n\n            Q.all(promiseArray).then(function () {\n                deferred.resolve(prams);\n            });\n\n            return deferred.promise;\n        },\n        colorful: function (word, $) {\n            let message = '';\n            Array.from(word, function (x, i) {\n                message += $.chalk[['red', 'yellow', 'green', 'blue', 'magenta', 'cyan', 'gray'][i%7]](x);\n            });\n            console.info(`[${ $.chalk.gray($.dateformat(new Date(), 'H:MM:ss')) }] >>> ${ message } &#x3C;&#x3C;&#x3C;`);\n        },\n        jobStart: function ($, time, taskName, base = null) {\n            console.info(`[${ $.chalk.gray($.dateformat(time, 'H:MM:ss')) }] ${ $.chalk.red('Starting') } '${ $.chalk.green(taskName) }' ... ${ base != null ? ' ==> ' + $.chalk.yellow(base) : '' }`);\n        },\n        jobEnd: function ($, time, taskName, defTime, base = null) {\n            console.info(`[${ $.chalk.gray($.dateformat(time, 'H:MM:ss')) }] ${ $.chalk.blue('Finished') } '${ $.chalk.green(taskName) }' in ${ $.chalk.magenta(defTime + ' ms') } ${ base != null ? ' ==> ' + $.chalk.yellow(base) : '' }`);\n        }\n    };\n\n    return config;\n};\n</code></pre>\n<h4>参数说明</h4>\n<p>isDev 开发与发布环境辨别的参数，默认值给了false，也就是开发环境。</p>\n<p>stage 发布环境状态的不同环境区分，例如: test、staging、release等</p>\n<h4>内部函数说明</h4>\n<p>system_list: 是立即执行函数，根据环境返回不同目录，最终是个数组。</p>\n<p>great_promise: 解决同一任务便利不同系统目录，并并发直行用的。</p>\n<p>jobStart &#x26; jobEnd：除了服务器脚本，其他所有的脚本都直接用 promise 实现，所以任务信息需要自己打出。</p>\n<h2> </h2>\n<h3>入口脚本配置 <code>gulpfile.babel.js</code></h3>\n<pre><code class=\"language-javascript\">'use strict';\n\nimport gulp         from 'gulp';\nimport $            from 'gulp-load-plugins';\nimport config       from './fescripts/gulp.config.js';\nimport Clean        from './fescripts/tasks/clean.task.js';\nimport Build        from './fescripts/tasks/build.task.js';\nimport Default      from './fescripts/tasks/default.task.js';\n\ngulp.task(\"clean\", function () {\n    return Clean(gulp, config(), $({\n        pattern: ['gulp-*', 'gulp.*', 'chalk', 'dateformat', 'q'],\n        lazy: true\n    }), gulp.env.taskName || 'all');\n});\n\ngulp.task(\"build\", function () {\n    return Build(gulp, config({\n        stage: process.argv.length >= 5 &#x26;&#x26; process.argv[4] || 'test'\n    }), $({\n        pattern: ['gulp-*', 'gulp.*', 'chalk', 'dateformat', 'q'],\n        lazy: true\n    }));\n});\n\ngulp.task(\"watch\", ['default'], function () {\n    return gulp.watch(['alphago/livecast/livecast-web/**/*.scss'], ['default']);\n});\n\ngulp.task(\"default\", function () {\n    return Default(gulp, config({\n        isDev: true\n    }), $({\n        pattern: ['gulp-*', 'gulp.*', 'chalk', 'dateformat', 'q'],\n        lazy: true\n    }));\n});\n</code></pre>\n<p>这里的 $ 不是 jQuery 的缩写，是 gulp 的一个插件 <code>gulp-load-plugins</code>。</p>\n<p>这插件会默认把 <code>package.json</code> 下 <code>gulp-</code> &#x26; <code>gulp.*</code> 开头的插件全部加载到环境中。</p>\n<p>如果需要，可以根据自己的需要修改 <code>pattern</code> 配置，加载更多其他插件。</p>\n<h2> </h2>\n<h3>编译脚本 <code>build.task.js</code></h3>\n<pre><code class=\"language-javascript\">'use strict';\n\nimport clean    from './clean.task.js';\nimport css      from './compile/css.compile.js';\nimport tools    from './compile/tools.compile.js'\nimport js       from './compile/js.compile.js';\nimport html     from './compile/html.compile.js';\nimport formal   from './debug/formal.mode.js';\n\nmodule.exports = function (gulp, config, $, param = true) {\n    return $.q.fcall(() => true).then(function () {\n        return clean(gulp, config, $);\n    }).then(function () {\n        return css(gulp, config, $);\n    }).then(function () {\n        return tools(gulp, config, $);\n    }).then(function () {\n        return js(gulp, config, $);\n    }).then(function () {\n        return html(gulp, config, $);\n    }).then(function () {\n        return config.isDev ? formal(gulp, config, $) : true;\n    }).then(function () {\n        return param;\n    });\n};\n</code></pre>\n<p>这里用到了 Node.js 的 q 模块</p>\n<h2> </h2>\n<h3>小任务脚本 <code>css.compile.js</code></h3>\n<pre><code class=\"language-javascript\">'use strict';\n\nmodule.exports = function (gulp, config, $, param = true) {\n    return $.q.fcall(() => true).then(function () {\n        return config.great_promise(function (base, def) {\n            let startTime = new Date();\n            config.jobStart($, startTime, 'Make css version', base);\n\n            gulp.src([\n                `${base}/public/css/*.css`,\n                `!${base}/public/css/*-*.css`\n            ])\n            .pipe($.plumber())\n            .pipe($.sourcemaps.write('maps', {\n                includeContent: false\n            }))\n            .pipe($.rev())\n            .pipe(gulp.dest(`${base}/public/css`))\n            .pipe($.rev.manifest())\n            .pipe(gulp.dest(`${base}/public/css`))\n            .on('end', function () {\n                let endTime = new Date();\n                config.jobEnd($, endTime, 'Make css version', endTime.getTime() - startTime.getTime(), base);\n\n                def.resolve();\n            });\n        });\n    }).then(function () {\n        return config.great_promise(function (base, def) {\n            let startTime = new Date();\n            config.jobStart($, startTime, 'Change links', base);\n\n            gulp.src([\n                `${base}/public/css/rev-manifest.json`,\n                `${base}/WEB-INF/livecast/layout/*links.ftl`\n            ])\n            .pipe($.plumber())\n            .pipe($.if(/\\.ftl$/, $.replace(/main(\\S*).css/g, 'main.css')))\n            .pipe($.revCollector())\n            .pipe(gulp.dest(`${base}/WEB-INF/livecast/layout/`))\n            .on('end', function () {\n                let endTime = new Date();\n                config.jobEnd($, endTime, 'Change links', endTime.getTime() - startTime.getTime(), base);\n\n                def.resolve();\n            });\n        });\n    }).then(function () {\n        return param;\n    });\n};\n</code></pre>\n<h2> </h2>\n<h3>运行后效果</h3>\n<img src=\"https://i.imgur.com/l6Jgsyi.jpg\" />\n<p>可以看到 <code>Recover links</code> 任务开始的顺序是 crm -> student -> teacher，最后完成顺序是 crm -> teacher -> student。</p>\n<p>每个具体任务间是串行，三个项目目录间同一个任务是并行的。</p>\n<hr>","frontmatter":{"path":"/HZuzV2Mry3o0cjvWK2JEBiBX","title":"重构你的 gulpfile","date":"2016-08-12 16:18:55 +0800","comments":true,"author":"Sir0xb","tags":["gulp","es6"]},"excerpt":"用 Node.js 的 Stream 概念，gulp 实现了一套自己的 pipe，再包裹上 Promise 机制，让每个功能在一个接一个的管道中流过，宏观上实现我们需要它完成的 Task。Task 很好用，于是用了很多，结果 gulpfile…"}}],"pathPrefix":"","first":false,"last":false,"index":11,"pageCount":15,"additionalContext":{}}}